@using Microsoft.EntityFrameworkCore
@using PlantHub.Web.Domain
@using PlantHub.Web.Infrastructure

@inject PlantHub.Web.Infrastructure.IWateringGroupService _groups
@inject PlantHub.Web.Infrastructure.IPlantService _plants
@inject IImageStorageService ImageStorage

@if (_groupsWithPlants is null)
{
    <p><em>Loading plants...</em></p>
}
else if (_groupsWithPlants.Count == 0)
{
    <p>No irrigation groups or plants were found.</p>
}
else
{
    <div class="ph-card-list">
        @foreach (var group in _groupsWithPlants)
        {
            <div class="ph-card">
                <div class="ph-card-header">
                    <span class="ph-card-title">@group.Name</span>
                    <span class="ph-card-subtitle">
                        @GetIntervalLabel(group)
                    </span>
                </div>

                @if (!string.IsNullOrWhiteSpace(group.Description))
                {
                    <p class="ph-card-description">@group.Description</p>
                }

                @if (group.Plants is { Count: > 0 })
                {
                    <div class="ph-plant-grid">
                        @foreach (var plant in group.Plants.OrderBy(p => p.Name))
                        {
                            <PlantCard Plant="plant"
                                       AreaName="@(ResolveAreaName(plant.AreaId))"
                                       WateringGroupName="@(plant.WateringGroup?.Name)"
                                       StatusBadge="@(GetStatusBadge(plant))"
                                       OnClick="@(p => OpenDetails(p))"
                                       OnEdit="@(p => HandleEditPlantClick(p))"
                                       OnWaterNow="@(p => MarkWateredNow(p))"
                                       OnCheckNow="HandleCheckNowForPlant"
                                       OnEditImage="OpenImageModal"
                                       OnDelete="@(p => RequestDelete(p))" />
                        }
                    </div>
                }
                else
                {
                    <p class="ph-empty-hint">No plants yet in this group.</p>
                }




                <div class="ph-card-footer">

                    @if (group.Plants is { Count: > 0 })
                    {
                        <PhTooltip Text="Water all plants in this group now">
                            <button type="button"
                                    class="ph-icon-btn ph-icon-btn-water"
                                    @onclick:stopPropagation="true"
                                    @onclick="() => RequestWaterGroup(group)">
                                <span class="ph-emoji" aria-hidden="true">💦</span>
                            </button>
                        </PhTooltip>
                    }

                    @if (OnAddPlant.HasDelegate)
                    {
                        <PhTooltip Text="Add plant to this group">
                            <button type="button"
                                    class="ph-icon-btn"
                                    @onclick="() => AddPlantToGroup(group)">
                                🌱
                            </button>
                        </PhTooltip>
                    }

                    <PhTooltip Text="Edit watering group settings">
                        <button type="button"
                                class="ph-icon-btn ph-icon-btn-edit"
                                @onclick:stopPropagation="true"
                                @onclick="() => HandleEditWateringGroupClick(group)">
                            <span class="ph-emoji" aria-hidden="true">🛠️</span>
                        </button>
                    </PhTooltip>


                    @if (group.Plants is { Count: 0 })
                    {
                        <PhTooltip Text="Delete group">
                            <button type="button"
                                    class="ph-icon-btn ph-icon-btn-delete"
                                    @onclick="() => RequestDeleteGroupAsync(group)">
                                🗑️
                            </button>
                        </PhTooltip>
                    }
                </div>

            </div>
        }
    </div>

    <PhConfirmModal IsOpen="_waterGroupConfirmOpen"
                    IsOpenChanged="@(v => _waterGroupConfirmOpen = v)"
                    Title="Water all plants"
                    Message="@(_pendingWaterGroup is null
                                        ? null
                                        : $"Water all plants in '{_pendingWaterGroup.Name}' now?")"
                CancelText="Cancel"
                ConfirmText="Water"
                OnConfirm="ConfirmWaterGroupAsync"
                OnCancel="CancelWaterGroup" />

    <PhConfirmModal IsOpen="_deleteOpen"
                    IsOpenChanged="@(v => _deleteOpen = v)"
                    Title="Delete plant"
                    Message="@(_pendingDelete is null ? null : $"Are you sure you want to delete '{_pendingDelete.Name}'? This cannot be undone.")"
                    CancelText="Cancel"
                    ConfirmText="Delete"
                    OnConfirm="ConfirmDeleteAsync"
                    OnCancel="CancelDelete" />

    <AddEditWateringGroupModal IsOpen="_showEditWateringGroupModal"
                           IsOpenChanged="OnEditWateringGroupModalChanged"
                           ExistingGroup="_editingGroup"
                           OnSave="HandleEditWateringGroupSave" />

    <AddEditPlantModal IsOpen="_showEditPlantModal"
                       Areas="Areas"
                       WateringGroups="_groupsWithPlants"
                       ExistingPlant="_editingPlant"
                       OnSave="HandleEditPlantSave"
                       IsOpenChanged="OnEditPlantModalChanged" />

    <EditPlantImageModal Plant="_selectedPlantForImage"
                         IsOpen="_isImageModalOpen"
                         OnClose="CloseImageModal" />
}

@code {
    [Inject] IServiceScopeFactory ScopeFactory { get; set; } = default!;
    [Inject] PhToastService Toasts { get; set; } = default!;
    [Parameter] public EventCallback<WateringGroup> OnAddPlant { get; set; }
    [Parameter] public IEnumerable<HaAreaLite> Areas { get; set; } = Enumerable.Empty<HaAreaLite>();
    [Parameter] public EventCallback<WateringGroup> OnDeleteGroup { get; set; }

    private List<WateringGroup> _groupsWithPlants = new();
    private bool _deleteOpen;
    private Plant? _pendingDelete;

    private bool _showEditWateringGroupModal;
    private WateringGroup? _editingGroup;

    private bool _showEditPlantModal;
    private Plant? _editingPlant;

    private bool _waterGroupConfirmOpen;
    private WateringGroup? _pendingWaterGroup;


    protected override async Task OnInitializedAsync()
    {
        await ReloadAsync();
    }

    private async Task AddPlantToGroup(WateringGroup group)
    {
        if (OnAddPlant.HasDelegate)
        {
            await OnAddPlant.InvokeAsync(group);
        }
    }

    // Handle "Check now" button click for a plant
    private async Task HandleCheckNowForPlant(Plant plant)
    {
        using var scope = ScopeFactory.CreateScope();
        var checker = scope.ServiceProvider.GetRequiredService<WateringCheckService>();
        await checker.RunAsync();
        Toasts.Show("Watering check completed. Notifications sent if needed.", PhToastLevel.Info);
    }

    // Handle Edit plant modal open/close changes
    private Task HandleEditPlantClick(Plant plant)
    {
        _editingPlant = plant;
        _showEditPlantModal = true;
        return Task.CompletedTask;
    }

    // Handle edit plant modal open/close changes
    private void OnEditPlantModalChanged(bool value)
    {
        _showEditPlantModal = value;

        if (!value)
        {
            _editingPlant = null;
        }
    }

    // Handle save from the edit plant modal
    private async Task HandleEditPlantSave(CreatePlantModel model)
    {
        if (_editingPlant is null)
            return;

        var changes = model.ToEntity();
        // 🔹 EDIT – uppdatera befintlig entity
        _editingPlant.Name = changes.Name;
        _editingPlant.LatinName = changes.LatinName;
        _editingPlant.AreaId = changes.AreaId;
        _editingPlant.WateringGroupId = changes.WateringGroupId;
        _editingPlant.PotVolumeMl = changes.PotVolumeMl;
        _editingPlant.Notes = changes.Notes;
        _editingPlant.Mode = changes.Mode;

        await _plants.UpdateAsync(_editingPlant);
        Toasts.Show($"Plant {_editingPlant.Name} updated", PhToastLevel.Success);

        _showEditPlantModal = false;
        _editingPlant = null;

        await ReloadAsync();
    }

    // Handle click on "edit" button for a watering group
    private Task HandleEditWateringGroupClick(WateringGroup group)
    {
        _editingGroup = group;
        _showEditWateringGroupModal = true;        
        return Task.CompletedTask;
    }

    // Handle modal open/close changes
    private void OnEditWateringGroupModalChanged(bool value)
    {
        _showEditWateringGroupModal = value;

        if (!value)
        {
            _editingGroup = null;
        }
    }

    // Handle save from the edit watering group modal
    private async Task HandleEditWateringGroupSave(CreateWateringGroupModel model)
    {
        if (_editingGroup is null)
            return;

        // Uppdatera entity med värden från formuläret
        _editingGroup.Name = model.Name;
        _editingGroup.Description = model.Description;
        _editingGroup.IntervalDaysSummer = model.IntervalDaysSummer;
        _editingGroup.IntervalDaysWinter = model.IntervalDaysWinter;
        _editingGroup.SummerStartMonth = model.SummerStartMonth;
        _editingGroup.SummerEndMonth = model.SummerEndMonth;
        _editingGroup.MinDaysBetween = model.MinDaysBetween;
        _editingGroup.MaxDaysBetween = model.MaxDaysBetween;

        await _groups.UpdateAsync(_editingGroup);
        Toasts.Show($"Watering group {_editingGroup.Name} updated", PhToastLevel.Success);

        // Stäng modalen
        _showEditWateringGroupModal = false;
        _editingGroup = null;

        await ReloadAsync();
    }

    public async Task RequestDeleteGroupAsync(WateringGroup group)
    {
        if (OnDeleteGroup.HasDelegate)
        {
            await OnDeleteGroup.InvokeAsync(group);
        }
    }

    public async Task ReloadAsync()
    {
        _groupsWithPlants = (await _groups.GetAllWithPlantsAsync()).ToList();
    }

    private void RequestDelete(Plant p)
    {
        _pendingDelete = p;
        _deleteOpen = true;
        StateHasChanged();
    }

    private async Task ConfirmDeleteAsync()
    {
        if (_pendingDelete is null)
            return;

        var img = _pendingDelete.ImageUrl;

        // 1. Delete plant from DB (authoritative source)
        await _plants.DeleteAsync(_pendingDelete);
        Toasts.Show($"Plant {_pendingDelete.Name} was deleted", PhToastLevel.Warning);

        // 2. Delete image file (best effort)
        if (!string.IsNullOrWhiteSpace(img))
        {
            try
            {
                ImageStorage.DeleteImage(img);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Failed to delete old image: {ex.Message}");
            }
        }

        // 3. Reset state and reload UI
        _pendingDelete = null;
        await ReloadAsync();
        StateHasChanged();
    }

    private void CancelDelete()
    {
        _pendingDelete = null;
        _deleteOpen = false;
    }

    private static string GetIntervalLabel(WateringGroup g)
    {
        // Short, human-friendly label for the card header
        return $"Summer: {g.IntervalDaysSummer} d • Winter: {g.IntervalDaysWinter} d";
    }

    private string? ResolveAreaName(string? areaId) => Areas.SingleOrDefault(a => a.Id == areaId)?.Name ?? areaId;
       

    private string? GetStatusBadge(Plant p)
    {
        var overdue = p.GetDaysOverdue();
        if (overdue is > 0) return "Needs water";
        return "OK";
    }

    // Wire up your UI actions
    private void OpenDetails(Plant p) { /* navigate or open side panel */ }
    
    private async Task MarkWateredNow(Plant p)
    {
        await _plants.MarkWateredAsync(p.Id);
        Toasts.Show($"Watered {p.Name} 💦", PhToastLevel.Success);
        await ReloadAsync();
        StateHasChanged();
    }

    private void RequestWaterGroup(WateringGroup group)
    {
        _pendingWaterGroup = group;
        _waterGroupConfirmOpen = true;
        StateHasChanged();
    }

    private async Task ConfirmWaterGroupAsync()
    {
        if (_pendingWaterGroup is null)
            return;

        await _plants.MarkWateredGroupAsync(_pendingWaterGroup.Id);
        Toasts.Show($"Watered {_pendingWaterGroup.Plants.Count} plants in '{_pendingWaterGroup.Name}' 💦", PhToastLevel.Success);

        _pendingWaterGroup = null;
        _waterGroupConfirmOpen = false;

        await ReloadAsync();
        StateHasChanged();
    }

    private void CancelWaterGroup()
    {
        _pendingWaterGroup = null;
        _waterGroupConfirmOpen = false;
    }

    private async Task WaterGroupNow(WateringGroup group)
    {
        await _plants.MarkWateredGroupAsync(group.Id);

        await ReloadAsync();
        StateHasChanged();
    }

    // Image editing
    private Plant? _selectedPlantForImage;
    private bool _isImageModalOpen;

    private void OpenImageModal(Plant plant)
    {
        _selectedPlantForImage = plant;
        _isImageModalOpen = true;
    }

    private void CloseImageModal()
    {
        _isImageModalOpen = false;
        _selectedPlantForImage = null;
    }

}
