@using PlantHub.Web.Domain 
@inherits ComponentBase

<div class="ph-plant-card" @onclick="() => OnClick.InvokeAsync(Plant)">
    <div class="ph-plant-media">
        @if (!string.IsNullOrWhiteSpace(Plant.ImageUrl))
        {
            <img src="@Plant.ImageUrl" alt="@Plant.Name" loading="lazy" />
        }
        else
        {
            <!-- Fallback avatar with initials -->
            <div class="ph-plant-avatar" aria-hidden="true">
                @GetInitials(Plant.Name)
            </div>
        }
        @if (!string.IsNullOrWhiteSpace(StatusBadge))
        {
            <span class="ph-badge ph-badge-status">@StatusBadge</span>
        }
    </div>

    <div class="ph-plant-body">
        <div class="ph-plant-title">
            <span class="ph-plant-name">@Plant.Name</span>
            @if (!string.IsNullOrWhiteSpace(Plant.LatinName))
            {
                <span class="ph-plant-latin">(@Plant.LatinName)</span>
            }
        </div>

        <div class="ph-plant-meta">
            @if (!string.IsNullOrWhiteSpace(AreaName ?? Plant.AreaId))
            {
                <span class="ph-chip">
                    <svg class="ph-ico" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2C8.1 2 5 5.1 5 9c0 5.2 7 13 7 13s7-7.8 7-13c0-3.9-3.1-7-7-7zm0 9.5c-1.4 0-2.5-1.1-2.5-2.5S10.6 6.5 12 6.5s2.5 1.1 2.5 2.5S13.4 11.5 12 11.5z" /></svg>
                    @(AreaName ?? Plant.AreaId)
                </span>
            }
            @if (WateringGroupName is not null)
            {
                <span class="ph-chip ph-chip-accent">@WateringGroupName</span>
            }

            @if (Plant.PotVolumeMl is not null)
            {
                <span class="ph-chip">
                    <span class="ph-emoji" aria-hidden="true">🪴</span>
                    @FormatPotVolume(Plant.PotVolumeMl.Value)
                </span>
            }
        </div>

        @if (Plant.GetLastWatered() is not null)
        {
            <div class="ph-plant-water">
                <span class="ph-water-label">Last watered</span>

                <span class="ph-water-date">@Plant.GetLastWatered()?.ToString("yyyy-MM-dd")</span>
            </div>
        }

        <div class="ph-plant-water">
            <span class="ph-water-label">Next watering</span>

            @if (Plant.GetLastWatered() is null)
            {
                <span class="ph-water-date">Never watered</span>
            }
            else
            {
                <span class="ph-water-date">@Plant.ComputeNextWaterDate()?.ToString("yyyy-MM-dd")</span>

                @if (Plant.GetDaysOverdue() is not null && Plant.GetDaysOverdue() > 0)
                {
                    <span class="ph-overdue">+@Plant.GetDaysOverdue() d</span>
                }
            }
        </div>

        
    </div>

    <div class="ph-plant-actions">
        @if (OnWaterNow.HasDelegate)
        {
            <PhTooltip Text="Water this plant now">
                <button type="button"
                        class="ph-icon-btn ph-icon-btn-water"
                        @onclick:stopPropagation="true"
                        @onclick="() => OnWaterNow.InvokeAsync(Plant)">
                    <span class="ph-emoji" aria-hidden="true">💦</span>
                </button>
            </PhTooltip>
        }

        @if (Plant.GetLastWatered() is null && OnCheckNow.HasDelegate)
        {
            <PhTooltip Text="Check watering now">
                <button type="button"
                        class="ph-icon-btn ph-icon-btn-check"
                        @onclick:stopPropagation="true"
                        @onclick="() => OnCheckNow.InvokeAsync(Plant)">
                    <span class="ph-emoji" aria-hidden="true">🧪</span>
                </button>
            </PhTooltip>
        }

         @if (OnEditImage.HasDelegate)
        {
            <PhTooltip Text="Edit plant image">
                <button type="button"
                        class="ph-icon-btn ph-icon-btn-image"
                        @onclick:stopPropagation="true"
                        @onclick="() => OnEditImage.InvokeAsync(Plant)">
                    <span class="ph-emoji" aria-hidden="true">📷</span>
                </button>
            </PhTooltip>
        }
        @if (OnEdit.HasDelegate)
        {
            <PhTooltip Text="Edit plant settings">
                <button type="button"
                        class="ph-icon-btn ph-icon-btn-edit"
                        @onclick:stopPropagation="true"
                        @onclick="() => OnEdit.InvokeAsync(Plant)">
                    <span class="ph-emoji" aria-hidden="true">🛠️</span>
                </button>
            </PhTooltip>
        }

        @if (OnDelete.HasDelegate)
        {
            <PhTooltip Text="Delete plant">
                <button type="button"
                        class="ph-icon-btn ph-icon-btn-delete"
                        @onclick:stopPropagation="true"
                        @onclick="() => OnDelete.InvokeAsync(Plant)">
                    <span class="ph-emoji" aria-hidden="true">🗑️</span>
                </button>
            </PhTooltip>
        }
    </div>

    

</div>

@code {
    [Parameter] public Plant Plant { get; set; } = default!;
    // Optional: pretty area name instead of raw AreaId
    [Parameter] public string? AreaName { get; set; }

    // Optional: display name for watering group
    [Parameter] public string? WateringGroupName { get; set; }

    

    // Optional: a small status badge, e.g. "Needs water", "OK", "Winter rest"
    [Parameter] public string? StatusBadge { get; set; }

    // Actions
    [Parameter] public EventCallback<Plant> OnClick { get; set; }
    [Parameter] public EventCallback<Plant> OnEdit { get; set; }
    [Parameter] public EventCallback<Plant> OnWaterNow { get; set; }
    [Parameter] public EventCallback<Plant> OnDelete { get; set; }
    [Parameter] public EventCallback<Plant> OnEditImage { get; set; }
    [Parameter] public EventCallback<Plant> OnCheckNow { get; set; }

    

    private static string GetInitials(string? s)
    {
        if (string.IsNullOrWhiteSpace(s)) return "🌿";
        var parts = s.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        return parts.Length switch
        {
            0 => "🌿",
            1 => parts[0].Substring(0, Math.Min(2, parts[0].Length)).ToUpperInvariant(),
            _ => (parts[0][0].ToString() + parts[^1][0]).ToUpperInvariant()
        };
    }

    private static string FormatPotVolume(int ml)
    {
        // Visa i liter med max 1 decimal, utan .0
        var liters = ml / 1000.0;

        if (liters >= 1)
            return $"{liters:0.#} L";

        // Små krukor: visa i ml
        return $"{ml} ml";
    }
}
