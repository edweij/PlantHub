@using PlantHub.Web.Domain
@using PlantHub.Web.Lib
@using PlantHub.Web.Components.Shared
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web
@inject IPlantService PlantService
@inject IImageStorageService ImageStorage

@if (IsOpen && Plant is not null)
{
    <div class="ph-modal" role="dialog" aria-modal="true" @onkeydown="HandleKeyDown">
        <div class="ph-modal-backdrop" @onclick="CloseAsync"></div>

        <div class="ph-modal-dialog ph-modal-dialog--sm ph-modal-dialog--elevated" tabindex="-1">
            <div class="ph-modal-header">
                <h2 class="ph-modal-title">Edit plant image</h2>
                <button type="button" class="ph-icon-btn" @onclick="CloseAsync">✕</button>
            </div>

            <EditForm EditContext="_editContext" OnValidSubmit="HandleValidSubmit">
                <DataAnnotationsValidator />

                <div class="ph-modal-body">

                    @if (!string.IsNullOrWhiteSpace(Plant.ImageUrl))
                    {
                        <div class="ph-field">
                            <label class="ph-label">Current image</label>
                            <img src="@Plant.ImageUrl" class="ph-plant-image-preview" />
                        </div>
                    }

                    <div class="ph-field">
                        <label class="ph-label">Upload new image</label>
                        <InputFile OnChange="@(async e => await HandleFileSelected(e))" />
                        <div class="ph-hint">Max 5 MB. JPG/PNG.</div>
                    </div>

                    @if (_newImagePreview is not null)
                    {
                        <div class="ph-field">
                            <label class="ph-label">Preview</label>
                            <img src="@_newImagePreview" class="ph-plant-image-preview" />
                        </div>
                    }

                    <ValidationSummary class="ph-validation-summary" />
                </div>

                <div class="ph-modal-footer">
                    <button type="button" class="ph-btn ph-btn-ghost" @onclick="CloseAsync">
                        Cancel
                    </button>

                    <button type="submit"
                            class="ph-btn ph-btn-primary"
                            disabled="@(!_hasFileToUpload)">
                        Save image
                    </button>
                </div>
            </EditForm>
        </div>
    </div>
}

@code {
    [Parameter] public Plant? Plant { get; set; }
    [Parameter] public bool IsOpen { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }

    private EditContext? _editContext;
    private IBrowserFile? _selectedFile;
    private bool _hasFileToUpload => _selectedFile is not null;
    private string? _newImagePreview;

    protected override void OnParametersSet()
    {
        if (IsOpen && Plant is not null)
        {
            _editContext = new EditContext(Plant);
        }
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        _selectedFile = e.File;

        // Läs filen asynkront till minne
        await using var stream = _selectedFile.OpenReadStream(5 * 1024 * 1024);
        await using var ms = new MemoryStream();
        await stream.CopyToAsync(ms);

        var base64 = Convert.ToBase64String(ms.ToArray());
        _newImagePreview = $"data:{_selectedFile.ContentType};base64,{base64}";
    }

    private async Task HandleValidSubmit()
    {
        if (Plant is null || _selectedFile is null)
            return;

        if (!string.IsNullOrWhiteSpace(Plant.ImageUrl))
        {
            try
            {
                ImageStorage.DeleteImage(Plant.ImageUrl);
            }
            catch (Exception ex)
            {
                // Log only – shouldn't block upload
                Console.WriteLine($"Failed to delete old image: {ex.Message}");
            }
        }

        // Save image and get the new URL
        var url = await ImageStorage.SavePlantImageAsync(_selectedFile);

        // Update model
        Plant.ImageUrl = url;
        await PlantService.UpdateAsync(Plant);

        await CloseAsync();
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Escape")
            await CloseAsync();
    }

    private async Task CloseAsync()
    {
        _selectedFile = null;
        _newImagePreview = null;
        await OnClose.InvokeAsync();
    }
}
